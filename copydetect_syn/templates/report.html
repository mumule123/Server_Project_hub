<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Copy Detection Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
  <style>
    h1 {
      text-align: center;
    }
    .highlight-green {
      background-color: #b6f2b6;
    }
    .highlight-red {
      background-color: #f2b6b6;
    }
    pre {
      text-align: left;
    }
    .col3 {
      float: left;
      width: 33%;
    }
    .file-info-list {
      max-height: 900px;
      overflow-y: scroll;
    }
    
    /* 高亮方式切换按钮样式 */
    .highlight-toggle {
      margin-top: 10px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .highlight-toggle button {
      padding: 8px 15px;
      margin-right: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      border: 2px solid #ddd;
      background-color: #f8f9fa;
      transition: all 0.3s;
    }
    
    .highlight-toggle button.active {
      background-color: #0d6efd;
      color: white;
      border-color: #0d6efd;
      box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
    
    .highlight-toggle button:hover:not(.active) {
      background-color: #e9ecef;
      border-color: #ced4da;
    }
    
    .highlight-mode-description {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
      margin-bottom: 10px;
      text-align: center;
    }
    
    /* 高亮模式图标 */
    .highlight-icon {
      margin-right: 5px;
    }
    
    /* 隐藏非当前显示的代码版本 */
    .char-level-code {
      display: none;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>
<body>
<div class="container" style="margin-top: 3em; max-width: 1400px">
  <h1 style="margin-bottom: 1em;">代码复用检测报告</h1>
  <h2><button id="saveButton">是否下载该报告</button></h2>
    <div class="row" style="font-size: small;">
      <div class="col3">
        <p>
          <b>检索代码 (vertical):</b> {{ test_count }}<br>
          <b>超过显示阈值的数量:</b> {{ flagged_file_count }} ({{ "%.2f"|format(flagged_file_count/test_count*100) }}%)<br><br>
          <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-test-files" aria-expanded="false" aria-controls="collapse-test-files">
            查看 <i>检索</i> 文件
          </button>
        </p>
        <div class="collapse" id="collapse-test-files">
          <ul class="file-info-list">
            {%- for file in test_files %}
              <li>{{ loop.index0 }}={{ file }}</li>
            {% endfor -%}
          </ul>
        </div>
      </div>
      <div class="col3">
        <p>
          <b>参考代码数量 (horizontal):</b> {{ compare_count }}<br><br><br>
          <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-reference-files" aria-expanded="false" aria-controls="collapse-reference-files">
            查看 <i>参考</i> 文件
          </button>
        </p>
        <div class="collapse" id="collapse-reference-files">
          <ul class="file-info-list">
            {%- for file in compare_files %}
              <li>{{ loop.index0 }}={{ file }}</li>
            {% endfor -%}
          </ul>
        </div>
      </div>
      <div class="col3">
        <p>
          <b>执行参数 <code></code>:</b><br><br><br>
          <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-exec-params" aria-expanded="false" aria-controls="collapse-exec-params">
            查看算法执行参数
          </button>
        </p>
        <div class="collapse" id="collapse-exec-params">
          <b>版本:</b> {{ version }}<br>
          <b>配置:</b>
          <pre class="file-info-list">{{config_params}}</pre>
        </div>
      </div>
    </div>


  <h2>匹配代码</h2>
  <table class="table table-striped table-sm">
  <tbody class="table-light">
  {% for code in code_list %}
  <tr>
  <td style="text-align: center;">
  <p>
    检索代码: <i>{{ code[2]|e }}</i> (<b>{{ "%.2f"|format(code[0]*100) }}%</b>)<br>
    被抄袭代码: <i>{{ code[3]|e }}</i> (<b>{{ "%.2f"|format(code[1]*100) }}%</b>)<br>
    Token overlap: {{ code[6] }}<br><br>
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{loop.index}}" aria-expanded="false" aria-controls="collapse-{{loop.index}}">
      观看他们相似代码高亮
    </button>
  </p>
  <div class="collapse" id="collapse-{{loop.index}}">
    <div class="card card-body">
      <!-- 添加高亮方式切换按钮 -->
      <div class="highlight-toggle" data-code-id="{{loop.index}}">
        <p class="highlight-mode-description">选择代码高亮方式：</p>
        <button class="default-highlight active" onclick="switchHighlight('{{loop.index}}', 'default')">
          <i class="bi bi-code-square highlight-icon"></i>默认高亮
        </button>
        <button class="char-level-highlight" onclick="switchHighlight('{{loop.index}}', 'char-level')">
          <i class="bi bi-text-paragraph highlight-icon"></i>字符级高亮
        </button>
      </div>
      <div class="highlight-mode-description" id="mode-description-{{loop.index}}">
        当前模式：<b>默认高亮</b> - 按代码块显示相似部分
      </div>
      
      <div class="row">
        <div class="col" style="max-width: 600px">
          <!-- 默认高亮代码 -->
          <pre class="default-code" id="default-code-left-{{loop.index}}"><code>{{ code[4] }}</code></pre>
          <!-- 字符级高亮代码 -->
          <pre class="char-level-code" id="char-level-code-left-{{loop.index}}"><code>{{ code[8] }}</code></pre>
        </div>
        <div class="col" style="max-width: 600px">
          <!-- 默认高亮代码 -->
          <pre class="default-code" id="default-code-right-{{loop.index}}"><code>{{ code[5] }}</code></pre>
          <!-- 字符级高亮代码 -->
          <pre class="char-level-code" id="char-level-code-right-{{loop.index}}"><code>{{ code[9] }}</code></pre>
        </div>
      </div>
    </div>
  </div>
  </td>
  </tr>
  {% endfor %}
  </tbody>
  </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
    <script>
        // 获取保存按钮元素
        const saveButton = document.getElementById('saveButton');

        // 添加点击事件监听器
        saveButton.addEventListener('click', () => {
            // 隐藏下载按钮
            saveButton.style.display = 'none';

            // 获取当前页面的 HTML 内容
            const htmlContent = document.documentElement.outerHTML;

            // 恢复下载按钮的显示
            saveButton.style.display = 'block';

            // 创建一个 Blob 对象，将页面内容放入其中
            const blob = new Blob([htmlContent], { type: 'text/html' });

            // 使用 URL.createObjectURL 创建一个下载链接
            const url = URL.createObjectURL(blob);

            // 创建一个下载链接元素
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'saved_page.html'; // 设置下载文件的名称

            // 模拟点击下载链接
            downloadLink.click();

            // 释放 URL 对象
            URL.revokeObjectURL(url);
        });

        // 切换高亮方式的函数
        function switchHighlight(codeId, mode) {
          // 更新按钮状态
          document.querySelectorAll(`.highlight-toggle[data-code-id="${codeId}"] button`).forEach(btn => {
            btn.classList.remove('active');
          });
          document.querySelector(`.highlight-toggle[data-code-id="${codeId}"] .${mode}-highlight`).classList.add('active');
          
          // 更新描述文本
          const descriptionElement = document.getElementById(`mode-description-${codeId}`);
          if (mode === 'default') {
            descriptionElement.innerHTML = '当前模式：<b>默认高亮</b> - 按代码块显示相似部分';
          } else {
            descriptionElement.innerHTML = '当前模式：<b>字符级高亮</b> - 精确显示每个相似字符';
          }
          
          // 切换代码显示
          if (mode === 'default') {
            document.getElementById(`default-code-left-${codeId}`).style.display = 'block';
            document.getElementById(`default-code-right-${codeId}`).style.display = 'block';
            document.getElementById(`char-level-code-left-${codeId}`).style.display = 'none';
            document.getElementById(`char-level-code-right-${codeId}`).style.display = 'none';
          } else {
            document.getElementById(`default-code-left-${codeId}`).style.display = 'none';
            document.getElementById(`default-code-right-${codeId}`).style.display = 'none';
            document.getElementById(`char-level-code-left-${codeId}`).style.display = 'block';
            document.getElementById(`char-level-code-right-${codeId}`).style.display = 'block';
          }
        }
    </script>
</body>
</html>
</body>